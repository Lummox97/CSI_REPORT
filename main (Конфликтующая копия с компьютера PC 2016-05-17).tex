\section{Постановка задачи}
Требуется разработать систему управления роботом манипулятором, применив метод очувствления при помощи силомоментного датчика. Также необходимо разработать протокол связи и управления роботом на основе сетевого протокола TCP IP и их интерпретатор на язык Kawasaki Robotic AS. Идентифицировать кинематическую модель, а также конвенцию углов Эйлера, в которой получается информация о текущем положении робота.. Создать и реализовать гомогенную среду для управления робототехническим комплексом на основе промышленного манипулятора Kawasaki FS06N с контроллером  Kawasaki D71+ и подключенного силомоментного датчика ATI F/T Sensor IP60 Delta Tranducer.Произвести апробацию полученных теоретических результатов алгоритмов  управления роботом-манипулятором в ходе эксперимента.
\section{Описание имеющегося оборудования}	
\subsection{Kawasaki fs06n}
В качестве робота-манипулятора был выбран  Kawasaki fs06n, в качестве контроллера - Kawasaki D71.
Основные характеристики представлены в Таблицах 1-3, Чертёж робота представлен в приложении А.
\begin{table}[h!]
	\caption{Основные характеристики робота} 
	\label{tab_kaw_main}
	\centering
	\begin{tabular}{|c|c|}				
		\hline Параметр & Значение  \\
		\hline Радиус действия &	1000 мм \\
		\hline Грузоподъёмность &	6 кг  \\ 
		\hline Число степеней подвижности &	6 \\ 
		\hline Точность позиционирования: &	$\pm$ 0,1 мм \\
		\hline Установка &	напольный, потолочный, настенный \\
		\hline Уровень защиты &	IP65 (ось JT5, JT6), IP7 \\
		\hline Контроллеры &	D42, D40, D70, D71 \\
		\hline
	\end{tabular} 
\end{table}
\begin{table}[h!]
	\caption{Технические характеристики} 
	\label{tab_kaw_teh}
	\centering
	\begin{tabular}{|p{0.7\linewidth}|p{0.22\linewidth}|}	
		\hline Параметр & Значение  \\
		\hline 	Максимальная линейная скорость& 	8000 мм/c \\
		\hline Номинальный крутящий момент запястного сочленения (оси 4,5,6)	&	12, 12, 6 Нм\\
		\hline Номинальный момент инерции запястного сочленения (оси 4,5,6)	&	0,24, 0,24, 0,07 $кгм^2$\\
		\hline
	\end{tabular} 
\end{table}\begin{table}[h!]
\caption{Параметры движения осей} 
\label{tab_kaw_joint}
\centering
\begin{tabular}{|c|c|c|}	
	\hline № Оси & Угол поворота осей & Скорость поворота осей  \\
	\hline 1 & 	от $-160^{~\circ}$ до   $160^{~\circ}$ & 	$240^{~\circ}/cек$ \\
	\hline 2 & 	от $-105^{~\circ}$ до   $140^{~\circ}$  & 	$200^{~\circ}/cек$ \\
	\hline 3 & 	от $-155^{~\circ}$  до  $120^{~\circ}$   & 	$250^{~\circ}/cек$ \\
	\hline 4 & 	от $-270^{~\circ}$  до  $270^{~\circ}$   & 	$430^{~\circ}/cек$ \\
	\hline 5 & 	от $-145^{~\circ}$  до  $145^{~\circ}$  & 	$430^{~\circ}/cек $ \\
	\hline 6 & 	от $-360^{~\circ}$  до  $360^{~\circ}$  & $720^{~\circ}/cек$ \\	    		
	\hline
\end{tabular} 
\end{table}
\begin{table}[h!]
	\caption{Классификация технических характеристик} 
	\label{tab_kaw_klass12}
	\centering
	\begin{tabular}{|p{0.35\linewidth}|p{0.27\linewidth}|p{0.3\linewidth}|}	
		\hline Техническая характеристика & 	Классификация & 	Значение \\
		\hline Грузоподъёмность	 & легкие & 	6 кг \\
		\hline Число степеней подвижности & 	средняя & 	6 \\
		\hline Величина и скорость перемещения рабочего органа & 	средняя	 & 650 мм \\
		\hline Быстродействие & 	высокое & 	8 м/с \\
		\hline Обьем рабочей зоны	 & средняя & 	2 м3\\
		\hline Погрешность позиционирования & 	1 класс точности & 	$0,05\%$ \\
		\hline Мобильность & 	подвижные & напольный, потолочный, настенный \\
		\hline Тип привода &  пр.	электрическая &\\	
		\hline Система координат & 	ангулярная &	\\
		\hline
	\end{tabular} 
\end{table}
\newpage
\subsection{ATI F/T IP60 Delta}
Силомоментный датчик F/T IP60 Delta измеряет 6 значений в режиме реального времене и передаёт их по сети. Предельные измеряемы значения, а также точностные характеристики представлены в Таблице 5.

\begin{table}[h]
	\caption{Классификация по техническим характеристикам} 
	\label{tab_kaw_klass}
	\centering
	\begin{tabular}{|c|c|c|}	
		\hline Направление измерений & 	Максимальное Значение & 	Точность \\
		\hline Fx,Fy & 	 660 N  & 	 1/8 N \\
		\hline Fz	 & 	   1980 N   & 	1/4 N \\
		\hline Tx,Ty & 		60 Nm & 		10/1333 Nm \\
		\hline  Tz	 & 	 60 Nm   & 	10/1333 Nm \\				
		\hline
	\end{tabular} 
\end{table}


\section{Разработка ПО}
\subsection{Формирование алгоритма управления}
Сетевая архитектура представлена на Рисунке 4.
\begin{figure}[h]
	\centering		 
	\includegraphics[width=5.5in]{./img/img42.jpg}	
	\caption{Сетевая архитектура}
	\label{fig_img511}
\end{figure}

У робота есть всего две группы параметров позиционирования: 
\begin{enumerate}
	
	\item{ углы поворотов шести джоинтов }
	\item{ Положение фланца, заданное в x,y,z координатах, и его ориентация, заданная в o,a,t углах  Эйлера в $zyz$ конвенции.}
\end{enumerate}

Т.к. робот получает управляющие команды по протоколу tcp ip, и контроль безошибочности передачи заложен в самом протоколе, то нам остаётся разработать собственный формат посылки.
\subsection{Структура посылки}
Т.к. при позиционировании робот использует 6 величин, то необходимо реализовать посылку следующим образом.

В силу функциональных особенностей внутреннего языка программирования контроллеров RoboticAS, самым оптимальным способом передачи данных по протоколу TCP IP является отправка символьных строк, содержащих в себе данные, разделённых пробелом (разделительным символом).  Единственное требование к такому представлению: каждое число должно быть представлено шестью символами. В случае, если число меньше $10^5$, то недостающие разряды должны быть заполнены цифрой 0. Например, число 123 должно быть представлено в выходной строке, как 000123.
Минимальная единица посылки, называемая кадром, является целым числом. 

Т.к. при использовании протокола tcp ip все символы строки гарантированно будут доставлены от передатчика к приёмнику, то механизм обработки принятых сообщений можно построить следующим образом: все входящие символы добавляются в буфер с конца, как только длина буфера превышает число $n=k*w$, где $k$ - кол-во кадров в посылке,$w$ - размер кадра в символах, то из буфера берутся первые $n$ символов и переводятся в $k$ целых чисел.

Т.к. параметров позиционирования у робота-манипулятора шесть, то в размер посылки требуется заложить в девять кадров.

\begin{figure}[ht]
	\centering		 
	\includegraphics{./img/img41.jpg}	
	\caption{
		\textbf{ Структура посылки:} 				
		ID- уникальный  номер управляющей команды(id);	 				
		Com - номер управляющей команды;	 				
		Param- параметр управляющей команды(запасной);	 				
		Vec1...Vec6 - вектор параметров управляющей команды}     
	\label{fig_img51}
\end{figure}

\subsection{Управление Кавасаки}
Всего есть три основных группы управления:
\begin{enumerate} 
	\item{По положению. Вектор параметров имеет следующую структуру: 
		
		1) Vec1 – X координата фланца;
		
		2) Vec2 – Y координата фланца;
		
		3) Vec3 – Z координата фланца;
		
		4) Vec4 – O угол Эйлера;
		
		5) Vec5 – A угол Эйлера; 
		
		6) Vec6 – T угол Эйлера;
	}
	\item{По абсолютным углам поворота джоинтов. i-ая координата отвечает угол поворота  i-го джоинта.}
	\item{По относительным углам поворота джоинтов.  i-ая координата отвечает  за относительный поворот  i-го джоинта.}
\end{enumerate}

Внутренняя программа контролера построена следующим образом: запущено 3 параллельных процесса: первый в бесконечном цикле отправляет данные о положении фланца, его ориентации и углах поворота шести джоинтов. Второй процесс в бесконечном цикле проверяет, не пришло ли новых символов и по каналу связи и добавляет их к буферу. Третий  процесс в бесконечном цикле обрабатывает входящие управляющие команды и запускает вспомогательные программы внутреннего управления, если такое управление было запущено.

\subsection{Внешние управляющие программы.}
\begin{enumerate}  
	\item{	Вывод робота в заданную точку по координатам (X,Y,Z,O,A,T). В вектор параметров передаются соответствующие координаты. }
	\item{	Вывод робота в заданную конфигурацию поворотов джоинтов. В вектор параметров передаются соответствующие углы поворота джоинтов.}
	\item{	Поворот джоинтов робота на заданные углы В вектор параметров передаются соответствующие углы поворотов джоинтов.
		При получении любой из первых трёх команд робот сразу же запускает внутреннюю команду перемещения. Поле Param остаётся нулевым.}
	\item{	Передача значений показаний силомоментного датчика в базовой системе координат (преобразование реальных показаний датчиков производится на стороне PC). Поле Param остаётся нулевым.}
	\item{	Задание скоростей и ускорений. Поле Param остаётся нулевым, значения Vec1-Vec4 следующие: ускорение в процентах, замедление в процентах, модульная скорость в процентах, механическая скорость в мм/с. Реальная скорость робота является произведением механической на модульную скорости.}
	\item{	Задание коэффициентов регулирования. При поле Param, равном нулю задаются пропорциональные коэффициенты $kx,ky,kz,kmx,kmy,kmz$, при поле Param, равном 1 задаются интегральные коэффициенты  $ix,iy,iz,imx,imy,Imz$.}
	\item{	Запуск программы force feedback. При Param, равном 0 – запускает "Force feedback position" режим стабилизации показаний $x,y,z$ компонент силомоментного датчика в нулевых значениях  за счёт смещений по $x,y,z$ осям. При Param равном 1 – запускается "Force feedback orientation" режим стабилизации $mx,my,mz$ показаний силомоментного датчика в нулевых значениях. При Param равном 2 останавливается выполнение force feedback.}
\end{enumerate}   

\subsection{Работа Force Feedback}

Из-за низкой производительности контроллера Kawasaki все математические вычисления производятся на ПК. Контроллер получает уже преобразованные значения $x,y,z$ компонент силы в базисе базовой системы координат. $M_x$, $M_y$ и $M_z$ – моменты, возникающие вдоль осей $x,y$ и $z$ базовой системы координат. Режим "Force feedback position" реализуется при помощи ПИ регулятора, где за ошибку берётся значения $x,y,z$ компонент силомоментного датчика. Выходом регулятора  является  новое положение робота на следующей итерации главного цикла программы.  

Режим "Force feedback orientation" реализуется более сложным способом. Также строится ПИ регулятор, за ошибку берутся показания моментов $Mx, My, Mz$, Выходом регулятора являются углы поворотов с третьего по шестой джоинтов.

Итого, можно сформировать три задачи:
\begin{enumerate}   
	\item{	Преобразование значения силы  из системы координат датчика в базовую систему координат и компенсация силы тяжести инструмента. }
	\item{	Преобразование значений моментов из системы координат датчика в базовую систему координат и компенсация момента силы тяжести инструмента.}
	\item{	Непосредственная реализация режимов force feedback.}
\end{enumerate}   
\section{Синтез управления}
\subsection{Идентификация}

\textbf{Системы координат}

Всего у нас будет 3 системы координат: 
\begin{enumerate}
	\item Связанная с основанием робота - базовая система координат. Центр системы координат выберем следующим образом: он будет находиться на пересечении оси вращения первого джоинта и горизонтальной плоскости, проходящей через ось вращения второго. Такое начало координат заложенно производителем. 
	\item Связанная с центром фланца рабочего инструмента.
	\item Связанная с силомоментным датчиком. 		
\end{enumerate}
Датчик закреплён на фланце робота таким образом, что оси z у них совпадают, систему координат, связанную с датчиком можно получить, повернув систему координат, связанную с фланцем, на угол $\frac{\pi}{2}$.
В итоге для реализации управления нам необходимо составить матрицы перехода из первой системы координат во вторую и из второй - в третью.
Обозначим матрицу перехода из первой системы во вторую ${M_{p12}}$, из второй в третью - ${M_{p23}}$.

\textbf{Нахождение матрицы перехода 1-2}

Для нахождения матрицы перехода из первой системы во вторую можно воспользоваться одним из двух способов: 
\begin{enumerate}
	\item Углы Эйлера в $zyz$ конвенции
	\item Прямая задача кинематики
\end{enumerate}





\textbf{Углы Эйлера}

От контроллера Kawasaki можно получить в режиме реального времени координаты $X,Y,Z$ и углы Эйлера $O, A, T$ в $zyz$ конвенции (Рисунок 6). По этим координатам мы можем построить матрицу перехода из первой системы координат во вторую:

\begin{equation}
{M_{p12}}=\begin{bmatrix} 
cOcAcT-sOsT & -cOcAcT-sOcT & cOsA & X \\ 
sOcAcT+cOsT & -sOcAsT+cOcT & sOsA & Y\\
-sAsT & sAsT & cA & Z \\
0 & 0 & 0 & 1
\end{bmatrix}
\end{equation}


\begin{figure}[ht]
	\centering		 
	\includegraphics[width=6in]{./img/img21.JPG}	
	\caption{
		\textbf{$ZYZ$ конвенция углов Эйлера
		}     
	}
	\label{fig_img1113}
\end{figure}	

\textbf{Прямая задача кинематики}

Методом Денавита-Хартенберга определяются кинематические параметры каждого звена манипулятора. Значения параметров представлены в Таблице 6, кинематическая схема на Рисунке 7. 

Обобщённую координату $i$-го джоинта обозначим как $\theta_{i}$.
Т.к. ось вращения первого джоинта направлена вертикально вниз, а z в базовой системе координат направлена вертикально вверх, было введено дополнительное преобразование из базовой системы координат в систему отсчёта первого джоинта.

\begin{figure}[h!]
	\centering		 
	\includegraphics[width=3in]{./img/img31.JPG}	
	\caption{
		\textbf{Кинематическая схема
		}     
	}
	\label{fig_img141}
\end{figure}

\begin{table}[h!]
	\caption{Кинематические звенья} 
	\label{tab_kaw_klass1}
	\centering
	\begin{tabular}{|c|c|c|c|c|}	
		
		\hline № Звена & $\theta_{i}$  & $d_{i}$ & 	$a_{i}$ & $\alpha_{i} $\\
		\hline	0 &  0                  & 0    & 0     & $pi$ \\
		\hline	1 &  $\theta_{1}-pi/2$  & 0    & 0.1   & $pi/2$ \\
		\hline	2 &  $\theta_{2}-pi/2$  & 0    & 0.45  & $pi $ \\
		\hline	3 &  $\theta_{3}+pi/2$  & 0    & 0.04  & $pi/2$  \\
		\hline	4 &  $\theta_{4}$       & 0.45 & 0     & $-pi/2 $  \\
		\hline	5 &  $\theta_{5}$       & 0    & 0     &$ pi/2$ \\ 
		\hline	6 &  $\theta_{6} +pi/2$ & 0.1  & 0      & 0  \\		
		\hline
	\end{tabular} 
\end{table}

Для $i$-го кинематического звена матрица перехода имеет вид: 


\begin{equation}
A_{i} =\begin{bmatrix}
c \theta & -s \theta c \alpha & s \theta s\alpha&   c \theta a\\
s\theta & c\theta c\alpha & -c\theta s\alpha & s \theta a\\
0       &    s\alpha   &         c\alpha &             d\\
0       &    0          &           0    &                  1\\
\end{bmatrix} 
\end{equation}
Тогда ${M_{p12}}=A_{0}A_{1}A_{2}A_{3}A_{4}A_{5}A_{6}$

\newpage
\textbf{Нахождение матрицы перехода 2-3}

Т.к. матрица перехода 2-3 постоянна и имеет тривиальную форму, она была объявлена как константа:
${M_{p12}}=\begin{bmatrix}
0 &-1&0&0\\ 1&0&0&0\\0 &0&1&0\\0&0&0&1\\
\end{bmatrix}$

\subsection{Обработка Сил}

\textbf{Компенсация внутренних силовых напряжений}

Т.к. монтаж датчика на фланец осуществлён совместно со схватом за счёт жёсткой фиксации, то возникают внутреннее давление которое порождает паразитные показания силы. 
Для определения паразитных сил зафиксируем фланец робота в двух положениях: вертикально вверх и вертикально вниз. Получены следующие значения: 

$\begin{pmatrix}
-12.5 \\ 0 \\ -50\\
\end{pmatrix}$ - для ориентации вертикально вверх

$\begin{pmatrix}
-12.5 \\ 0 \\ 10\\
\end{pmatrix} $- для ориентации  вертикально вниз.

Отсюда получается, что внутреннее напряжение равно по оси $x$ 12.5H, а по оси $z$ -20H. Учитывая, что инструмент и монтажные элементы весят примерно 3кг, можно сделать вывод о правильных расчётах.

В результате получен вектор внутренних напряжений: 
$F_{v}=\begin{pmatrix}
-12.5 \\ 0 \\ -20\\
\end{pmatrix} $

\textbf{Компенсация силы тяжести}

Пусть матрица перехода из системы координат датчика в базовую систему координат ${M_{p13}}={M_{p12}}{M_{p23}}$.
Т.к. сила тяжести направлена всегда вертикально вниз, то вектор силы тяжести в базовой системе координат однозначно определён. Т.о. необходимо перевести вектор силы тяжести из базовой системы координат в систему координат датчика. 
$F_{1} = \begin{pmatrix}
0 \\ 0 \\ -30\\
\end{pmatrix}$, тогда в системе координат датчика $F_{g}=M_{13}^{-1} F_{1}$.

\textbf{Перевод измерений датчика в базовую систему координат}

Пусть $F_{0}$ - вектор сил, полученный с датчика. Тогда вектор показаний $F_{r}$, в котором уже скомпенсированны внутренние напряжения и сила тяжести:
$F_{r}=	F_{0}-F_{v}-F_{g}$.

Тогда показания датчика в базовой системе координат будут следующими:
$F_{r}^*=M_{13}F_{r}$
\subsection{Обработка Моментов}

\textbf{Компенсация внутренних напряжений}

По причинам, описанным выше в системе при ориентации вертикально вверх (все моменты, порождённые внешними силами, должны быть равны 0)
мы получаем ненулевые значения. 
Пусть вектор внутренних моментов $M_{v}$, тогда 
$M_{v}= \begin{pmatrix}
-0.34 \\ -0.18 \\ 0.52\\
\end{pmatrix}$

\textbf{Компенсация момента силы тяжести}

Для того, чтобы скомпенсировать момент силы тяжести, был введён вектор, соединяющий центр фланца и центр тяжести инструмента при ориентированном вертикально вверх инструменте:

$r_{c_0} =  \begin{pmatrix}
0 \\ 0 \\ 0.07\\
\end{pmatrix}$

тогда вектор соединяющий центр фланца и центр тяжести в произвольной конфигурации робота $r_{c}$ будет равен $M_{13}r_{c_0}$.

Тогда момент силы тяжести в произвольном конфигурации в базовой системе координат равен в базовой системе координат $M_{g_0}=r{c}\times\begin{pmatrix}
0 \\ 0 \\ -30\\
\end{pmatrix}$

В системе координат датчика тогда момент будет:

$M_{g}=M_{13}^{-1}M_{g_0}$

\textbf{Перевод измерений датчика в систему обобщённых координат}

Пусть $M_{0}$ - вектор моментов, полученный с датчика. Тогда вектор показаний $M_{r}$, в котором уже скомпенсированны внутренние напряжения и сила тяжести:
$M_{r}=	M_{0}-M_{v}-M_{g}$.		

Управление будет построено следующим образом: необходимо взять первые четыре джоинта, после чего последовательно переходить от системы координат шестого джоинта к системе координат третьего джоинта.

Перед каждым переходом $z$ координату вектора моментов необходимо сохранить в качестве приведённого момента $m_{i}$. После чего следует обнулить $z$ - координату вектора моментов и умножить полученный вектор на обратную матрицу поворота из $(i-1)$-ой системы координат в $i$-ю.

$\begin{pmatrix}
x_{i-1} \\ y_{i-1} \\ z_{i-1}\\
\end{pmatrix} = 
\begin{pmatrix}
x_{i} \\ y_{i} \\ 0\\
\end{pmatrix} M_{i(i-1)_{3x3}}^{-1}$

\textbf{Углы Эйлера}

От контроллера Kawasaki можно получить в режиме реального времени координаты $X,Y,Z$ и углы Эйлера $O, A, T$ в $zyz$ конвенции (Рисунок 6). По этим координатам мы можем построить матрицу перехода из первой системы координат во вторую:

${M_{p12}}=\begin{bmatrix} 
cOcAcT-sOsT & -cOcAcT-sOcT & cOsA & X \\ 
sOcAcT+cOsT & -sOcAsT+cOcT & sOsA & Y\\
-sAsT & sAsT & cA & Z \\
0 & 0 & 0 & 1
\end{bmatrix}$ 

\begin{figure}[ht]
	\centering		 
	\includegraphics[width=6in]{./img/img21.JPG}	
	\caption{
		\textbf{$ZYZ$ конвенция углов Эйлера
		}     
	}
	\label{fig_img113}
\end{figure}	

\textbf{Прямая задача кинематики}

Методом Денавита-Хартенберга определяются кинематические параметры каждого звена манипулятора. Значения параметров представлены в Таблице 6, кинематическая схема на рисунке 7. 

Обобщённую координату $i$-го джоинта обозначим как $\theta_{i}$.
Т.к. ось вращения первого джоинта направлена вертикально вниз, а z в базовой системе координат направлена вертикально вверх, было введено дополнительное преобразование из базовой системы координат в систему отсчёта первого джоинта.

\begin{figure}[h!]
	\centering		 
	\includegraphics[width=3in]{./img/img31.JPG}	
	\caption{
		\textbf{Кинематическая схема
		}     
	}
	\label{fig_img14}
\end{figure}

\begin{table}[h!]
	\caption{Кинематические звенья} 
	\label{tab_kaw_klass1}
	\centering
	\begin{tabular}{|c|c|c|c|c|}	
		
		\hline № Звена & $\theta_{i}$  & $d_{i}$ & 	$a_{i}$ & $\alpha_{i} $\\
		\hline	0 &  0                  & 0    & 0     & $pi$ \\
		\hline	1 &  $\theta_{1}-pi/2$  & 0    & 0.1   & $pi/2$ \\
		\hline	2 &  $\theta_{2}-pi/2$  & 0    & 0.45  & $pi $ \\
		\hline	3 &  $\theta_{3}+pi/2$  & 0    & 0.04  & $pi/2$  \\
		\hline	4 &  $\theta_{4}$       & 0.45 & 0     & $-pi/2 $  \\
		\hline	5 &  $\theta_{5}$       & 0    & 0     &$ pi/2$ \\ 
		\hline	6 &  $\theta_{6} +pi/2$ & 0.1  & 0      & 0  \\		
		\hline
	\end{tabular} 
\end{table}

Для $i$-го кинематического звена матрица перехода имеет вид: 
\newline

$A_{i} =\begin{bmatrix}
c \theta & -s \theta c \alpha & s \theta s\alpha&   c \theta a\\
s\theta & c\theta c\alpha & -c\theta s\alpha & s \theta a\\
0       &    s\alpha   &         c\alpha &             d\\
0       &    0          &           0    &                  1\\
\end{bmatrix}$ 

Тогда ${M_{p12}}=A_{0}A_{1}A_{2}A_{3}A_{4}A_{5}A_{6}$

\textbf{Нахождение матрицы перехода 2-3}

Т.к. матрица перехода 2-3 постоянна и имеет тривиальную форму, она была объявлена как константа:
\begin{equation}
{M_{p12}}=\begin{bmatrix}
0 &-1&0&0\\ 1&0&0&0\\0 &0&1&0\\0&0&0&1\\
\end{bmatrix}
\end{equation}
\subsection{Обработка Сил}

\textbf{Компенсация внутренних силовых напряжений}

Т.к. монтаж датчика на фланец осуществлён совместно со схватом за счёт жёсткой фиксации, то возникают внутреннее давление которое порождает паразитные показания силы. 
Для определения паразитных сил зафиксируем фланец робота в двух положениях: вертикально вверх и вертикально вниз. Получены следующие значения: 

$\begin{pmatrix}
-12.5 \\ 0 \\ -50\\
\end{pmatrix}$ - для ориентации вертикально вверх

$\begin{pmatrix}
-12.5 \\ 0 \\ 10\\
\end{pmatrix} $- для ориентации  вертикально вниз.

Отсюда получается, что внутреннее напряжение равно по оси $x$ 12.5H, а по оси $z$ -20H. Учитывая, что инструмент и монтажные элементы весят примерно 3кг, можно сделать вывод о правильных расчётах.

В результате получен вектор внутренних напряжений: 

$F_{v}=\begin{pmatrix}
-12.5 \\ 0 \\ -20\\
\end{pmatrix} $

\textbf{Компенсация силы тяжести}

Пусть матрица перехода из системы координат датчика в базовую систему координат ${M_{p13}}={M_{p12}}{M_{p23}}$.
Т.к. сила тяжести направлена всегда вертикально вниз, то вектор силы тяжести в базовой системе координат однозначно определён. Т.о. необходимо перевести вектор силы тяжести из базовой системы координат в систему координат датчика. 
$F_{1} = \begin{pmatrix}
0 \\ 0 \\ -30\\
\end{pmatrix}$, тогда в системе координат датчика $F_{g}=M_{13}^{-1} F_{1}$.

\textbf{Перевод измерений датчика в базовую систему координат}

Пусть $F_{0}$ - вектор сил, полученный с датчика. Тогда вектор показаний $F_{r}$, в котором уже скомпенсированны внутренние напряжения и сила тяжести:
$F_{r}=	F_{0}-F_{v}-F_{g}$.

Тогда показания датчика в базовой системе координат будут следующими:
$F_{r}^*=M_{13}F_{r}$
\subsection{Обработка Моментов}

\textbf{Компенсация внутренних напряжений}

По причинам, описанным выше в системе при ориентации вертикально вверх (все моменты, порождённые внешними силами, должны быть равны 0)
мы получаем ненулевые значения. 
Пусть вектор внутренних моментов $M_{v}$, тогда 
$M_{v}= \begin{pmatrix}
-0.34 \\ -0.18 \\ 0.52\\
\end{pmatrix}$

\textbf{Компенсация момента силы тяжести}

Для того, чтобы скомпенсировать момент силы тяжести, был введён вектор, соединяющий центр фланца и центр тяжести инструмента при ориентированном вертикально вверх инструменте:

$r_{c_0} =  \begin{pmatrix}
0 \\ 0 \\ 0.07\\
\end{pmatrix}$

тогда вектор соединяющий центр фланца и центр тяжести в произвольной конфигурации робота $r_{c}$ будет равен

 $M_{13}r_{c_0}$.

Тогда момент силы тяжести в произвольном конфигурации в базовой системе координат равен в базовой системе координат $M_{g_0}=r{c}\times\begin{pmatrix}
0 \\ 0 \\ -30\\
\end{pmatrix}$

В системе координат датчика тогда момент будет:

$M_{g}=M_{13}^{-1}M_{g_0}$

\textbf{Перевод измерений датчика в систему обобщённых координат}

Пусть $M_{0}$ - вектор моментов, полученный с датчика. Тогда вектор показаний $M_{r}$, в котором уже скомпенсированны внутренние напряжения и сила тяжести:
$M_{r}=	M_{0}-M_{v}-M_{g}$.		

Управление будет построено следующим образом: необходимо взять первые четыре джоинта, после чего последовательно переходить от системы координат шестого джоинта к системе координат третьего джоинта.

Перед каждым переходом $z$ координату вектора моментов необходимо сохранить в качестве приведённого момента $m_{i}$. После чего следует обнулить $z$ - координату вектора моментов и умножить полученный вектор на обратную матрицу поворота из $(i-1)$-ой системы координат в $i$-ю.

$\begin{pmatrix}
x_{i-1} \\ y_{i-1} \\ z_{i-1}\\
\end{pmatrix} = 
\begin{pmatrix}
x_{i} \\ y_{i} \\ 0\\
\end{pmatrix} M_{i(i-1)_{3x3}}^{-1}$

\subsection{Построение регуляторов}

\textbf{Определение формы задающих воздействий}

Т.к. единственный способ управления роботом представляет из себя формирование задания по относительному смещению рабочего инструмента или относительному повороту джоинта, выход регулятора будет представлять собой вектор смещения $\begin{pmatrix}
\Delta x \\ \Delta y \\ \Delta z \\
\end{pmatrix} $ в случае управления по силе и вектор поворотов

$\begin{pmatrix}
\Delta \theta_{3}\\ \Delta \theta_{4} \\ \Delta \theta_{5} \\ \Delta \theta_{6} \\ \end{pmatrix} $ в случае управления по моментам

Для реализации управления используется трёх-канальный ПИ-регулятор в случае управления по силам, принимающий на вход вектор сил и четырёх-канальный в случае управления по моментам, принимающий на вход вектор приведённых моментов.

\textbf{Вычисление интегральной ошибки}

Т.к. в распоряжении имеется дискретная система, то для подсчёта интегральной компоненты реализована FIFO структура, иными словами, очередь фиксированной длины. Значение интегральной компоненты равно сумме всех элементов очереди.

	\section{Эксперимент}
	Для проверки математических расчётов было организовано 2 эксперимента: управление по моментам и управление по силам.	
		 \subsection{Управление по силам}
		 На Рисунках 10-15 показаны графики, иллюстрирующие реализованное управление в режиме "force feedback position"
	
		\begin{figure}[!h]
			\centering		 
			\includegraphics[width=2in]{./graph/posX.jpg}	
			\caption{
				\textbf{X - канал: положения}
			}     
			\label{fig_img41}
		\end{figure}
		\begin{figure}[!h]
			\centering		 
			\includegraphics[width=2in]{./graph/powX.jpg}	
			\caption{
				\textbf{X - канал: силы}
			}
			\label{fig_img42}
		\end{figure}
		\begin{figure}[!h]
			\centering		 
			\includegraphics[width=2in]{./graph/posY.jpg}	
			\caption{
				\textbf{Y - канал: положения}
			}
			\label{fig_img43}
		\end{figure}
		\begin{figure}[!h]
			\centering		 
			\includegraphics[width=2in]{./graph/powY.jpg}	
			\caption{
				\textbf{Y - канал: силы}
			}
			\label{fig_img44}
		\end{figure}		
		\begin{figure}[!h]
			\centering		 
			\includegraphics[width=2in]{./graph/posZ.jpg}	
			\caption{
				\textbf{Z - канал: положения}
			}
			\label{fig_img45}
		\end{figure}
		\begin{figure}[!h]
			\centering		 
			\includegraphics[width=4cm]{./graph/powZ.jpg}	
			\caption{
				\textbf{Z - канал: силы}
			}
			\label{fig_img46}
		\end{figure}
		
					\subsection{Управление по моментам}
					На Рисунках 16-21 показаны графики, иллюстрирующие реализованное управление в режиме "force feedback orientation"
					
					\begin{figure}[h!]
						\centering		 
						\includegraphics[width=2in]{./graph/j4.jpg}	
						\caption{
							\textbf{канал четвёртого джоинта: угол}
						}     
						\label{fig_img151}
					\end{figure}
					\begin{figure}[h!]
						\centering		 
						\includegraphics[width=2in]{./graph/m4.jpg}	
						\caption{
							\textbf{канал четвёртого джоинта: момент}
						}
						\label{fig_img54}
					\end{figure}
					\begin{figure}[h!]
						\centering		 
						\includegraphics[width=2in]{./graph/j5.jpg}	
						\caption{
							\textbf{канал пятого джоинта: угол}
						}
						\label{fig_img52}
					\end{figure}
					\begin{figure}[h!]
						\centering		 
						\includegraphics[width=2in]{./graph/m5.jpg}	
						\caption{
							\textbf{канал пятого джоинта: момент}
						}
						\label{fig_img55}
					\end{figure}
					\begin{figure}[h!]
						\centering		 
						\includegraphics[width=2in]{./graph/j6.jpg}	
						\caption{
							\textbf{канал шестого джоинта: угол}
						}
						\label{fig_img53}
					\end{figure}					
					\begin{figure}[h!]
						\centering		 
						\includegraphics[width=2in]{./graph/m6.jpg}	
						\caption{
							\textbf{канал шестого джоинта: момент}
						}
						\label{fig_img56}
					\end{figure}
					
		\subsection{Результаты экспериментов}
		Из графиков наглядно видно, что система имеет серьёзное запаздывание, что вызвано <<шаговостью>> робота-манипулятора. 
		Тем не менее система корректно отрабатывает задание, следовательно, поставленная задача выполнена.	
		
		